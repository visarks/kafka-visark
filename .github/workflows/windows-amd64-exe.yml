name: windows-amd64-exe

on:
  workflow_dispatch

jobs:
  build:
    runs-on: windows-2022
    env:
      APP_VERSION: ""

    steps:
      - name: 检出项目
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 设置 Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'zulu'
          cache: 'maven'

      - name: 解析版本号
        shell: pwsh
        run: |
          # 使用更可靠的 Maven 命令
          $versionRaw = mvn org.apache.maven.plugins:maven-help-plugin:3.3.0:evaluate `
            -Dexpression=project.version `
            -q `
            -DforceStdout `
            -Doutput="false" 2>&1 | Out-String

          # 清理输出（移除 XML 警告/错误）
          $lines = $versionRaw -split "`n"
          $versionLine = $lines | Where-Object { $_ -match '^\d+\.\d+\.\d+.*$' } | Select-Object -First 1

          if (-not $versionLine) {
            Write-Host "❌ 无法从输出中提取版本号，使用 XML 解析作为备选"
            $pomContent = Get-Content -Path "pom.xml" -Raw
            $xml = [xml]$pomContent
            $ns = New-Object System.Xml.XmlNamespaceManager($xml.NameTable)
            $ns.AddNamespace("pom", "http://maven.apache.org/POM/4.0.0")
            $versionLine = $xml.SelectSingleNode("//pom:version", $ns).InnerText
          }

          $cleanVersion = $versionLine.Trim() -replace '-SNAPSHOT$', ''

          "APP_VERSION=$cleanVersion" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

          Write-Host "✅ 项目版本: $cleanVersion"

      - name: 验证 Java
        shell: cmd
        run: |
          java -version
          echo JAVA_HOME: %JAVA_HOME%

      - name: 执行打包 (Windows EXE)
        shell: cmd
        run: mvn clean javafx:jlink -DAPP_TYPE=exe -DAPP_VERSION=%APP_VERSION%

      - name: 显示项目结构 (Windows 兼容)
        shell: pwsh
        run: |
          Write-Host "--- 项目目录结构 ---"
          Get-ChildItem -Path . -Depth 3 | Format-Table FullName

      - name: 列举生成的构建物
        shell: pwsh
        run: |
          $outputDir = "target\javafx"
          if (Test-Path $outputDir) {
            Write-Host "✅ 找到构建输出目录: $outputDir"
            Get-ChildItem $outputDir -Recurse | Format-List
          } else {
            Write-Host "❌ 未找到输出目录，检查构建过程"
            Get-ChildItem target -Recurse
            exit 1
          }

      - name: 重命名 EXE 文件
        shell: pwsh
        run: |
          $outputDir = "target\javafx"
          $originalFile = Get-ChildItem -Path $outputDir -Filter "*.exe" | Select-Object -First 1
          
          if ($originalFile) {
            $newName = "kafka-visark-$env:APP_VERSION-windows-amd64.exe"
            $newPath = Join-Path $outputDir $newName
          
            Rename-Item -Path $originalFile.FullName -NewName $newName -Force
            Write-Host "✅ 重命名成功: $newName"
            echo "ARTIFACT_PATH=$newPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          } else {
            Write-Host "❌ 未找到 EXE 文件"
            exit 1
          }

      - name: 上传 EXE 构建物
        uses: actions/upload-artifact@v4
        with:
          name: kafka-visark-${{ env.APP_VERSION }}-windows-amd64
          path: ${{ env.ARTIFACT_PATH }}
          retention-days: 30