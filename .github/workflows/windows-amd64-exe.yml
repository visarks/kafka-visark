name: windows-amd64-exe

on:
  workflow_dispatch

jobs:
  build:
    runs-on: windows-2022
    env:
      APP_VERSION: ""

    steps:
      - name: æ£€å‡ºé¡¹ç›®
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: è®¾ç½® Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'zulu'
          cache: 'maven'

      - name: è§£æç‰ˆæœ¬å· (PowerShell)
        shell: pwsh
        run: |
          # ä» pom.xml è·å–ç‰ˆæœ¬å·
          $rawVersion = mvn help:evaluate -Dexpression=project.version -q -DforceStdout 2>&1 | Out-String
          $cleanVersion = $rawVersion.Trim() -replace '-SNAPSHOT$', ''
          
          # æ­£ç¡®è®¾ç½® GitHub Actions ç¯å¢ƒå˜é‡
          "APP_VERSION=$cleanVersion" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          
          Write-Host "âœ… é¡¹ç›®ç‰ˆæœ¬: $cleanVersion"
          Write-Host "ğŸ› ï¸ ç¯å¢ƒå˜é‡å·²è®¾ç½®: APP_VERSION=$cleanVersion"

      - name: éªŒè¯ Java
        shell: cmd
        run: |
          java -version
          echo JAVA_HOME: %JAVA_HOME%

      - name: æ‰§è¡Œæ‰“åŒ… (Windows EXE)
        shell: cmd
        run: mvn clean javafx:jlink -DAPP_TYPE=exe -DAPP_VERSION=%APP_VERSION%

      - name: æ˜¾ç¤ºé¡¹ç›®ç»“æ„ (Windows å…¼å®¹)
        shell: pwsh
        run: |
          Write-Host "--- é¡¹ç›®ç›®å½•ç»“æ„ ---"
          Get-ChildItem -Path . -Depth 3 | Format-Table FullName

      - name: åˆ—ä¸¾ç”Ÿæˆçš„æ„å»ºç‰©
        shell: pwsh
        run: |
          $outputDir = "target\javafx"
          if (Test-Path $outputDir) {
            Write-Host "âœ… æ‰¾åˆ°æ„å»ºè¾“å‡ºç›®å½•: $outputDir"
            Get-ChildItem $outputDir -Recurse | Format-List
          } else {
            Write-Host "âŒ æœªæ‰¾åˆ°è¾“å‡ºç›®å½•ï¼Œæ£€æŸ¥æ„å»ºè¿‡ç¨‹"
            Get-ChildItem target -Recurse
            exit 1
          }

      - name: é‡å‘½å EXE æ–‡ä»¶
        shell: pwsh
        run: |
          $outputDir = "target\javafx"
          $originalFile = Get-ChildItem -Path $outputDir -Filter "*.exe" | Select-Object -First 1
          
          if ($originalFile) {
            $newName = "kafka-visark-$env:APP_VERSION-windows-amd64.exe"
            $newPath = Join-Path $outputDir $newName
          
            Rename-Item -Path $originalFile.FullName -NewName $newName -Force
            Write-Host "âœ… é‡å‘½åæˆåŠŸ: $newName"
            echo "ARTIFACT_PATH=$newPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          } else {
            Write-Host "âŒ æœªæ‰¾åˆ° EXE æ–‡ä»¶"
            exit 1
          }

      - name: ä¸Šä¼  EXE æ„å»ºç‰©
        uses: actions/upload-artifact@v4
        with:
          name: kafka-visark-${{ env.APP_VERSION }}-windows-amd64
          path: ${{ env.ARTIFACT_PATH }}
          retention-days: 30