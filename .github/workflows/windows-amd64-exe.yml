name: windows-amd64-exe

on:
  workflow_dispatch

jobs:
  build:
    runs-on: windows-2022
    env:
      APP_VERSION: ""

    steps:
      - name: 检出项目
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 设置 Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'zulu'
          cache: 'maven'

      - name: 解析版本号 (GitHub Actions 内置)
        id: get-version
        run: |
          # 读取 pom.xml 作为文本
          $pom = Get-Content -Path pom.xml -Raw

          # 使用正则提取版本
          if ($pom -match '<version>([\d\.]+(-SNAPSHOT)?)</version>') {
            $rawVersion = $matches[1]
            $cleanVersion = $rawVersion -replace '-SNAPSHOT$', ''

            "APP_VERSION=$cleanVersion" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            echo "version=$cleanVersion" >> $env:GITHUB_OUTPUT

            Write-Host "✅ 项目版本: $cleanVersion"
          } else {
            Write-Host "❌ 无法在 pom.xml 中找到 <version> 标签"
            exit 1
          }
        shell: pwsh

      - name: 验证 Java
        shell: cmd
        run: |
          java -version
          echo JAVA_HOME: %JAVA_HOME%

      - name: 执行打包 (Windows EXE)
        shell: cmd
        run: mvn clean jfx:package -DAPP_TYPE=exe -DAPP_VERSION=%APP_VERSION%

      - name: 显示项目结构 (Windows 兼容)
        shell: pwsh
        run: |
          Write-Host "--- 项目目录结构 ---"
          Get-ChildItem -Path . -Depth 3 | Format-Table FullName

      - name: 列举生成的构建物
        shell: pwsh
        run: |
          $outputDir = "target\javafx"
          if (Test-Path $outputDir) {
            Write-Host "✅ 找到构建输出目录: $outputDir"
            Get-ChildItem $outputDir -Recurse | Format-List
          } else {
            Write-Host "❌ 未找到输出目录，检查构建过程"
            Get-ChildItem target -Recurse
            exit 1
          }

      - name: 重命名 EXE 文件
        shell: pwsh
        run: |
          $outputDir = "target\javafx"
          $originalFile = Get-ChildItem -Path $outputDir -Filter "*.exe" | Select-Object -First 1
          
          if ($originalFile) {
            $newName = "kafka-visark-$env:APP_VERSION-windows-amd64.exe"
            $newPath = Join-Path $outputDir $newName
          
            Rename-Item -Path $originalFile.FullName -NewName $newName -Force
            Write-Host "✅ 重命名成功: $newName"
            echo "ARTIFACT_PATH=$newPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          } else {
            Write-Host "❌ 未找到 EXE 文件"
            exit 1
          }

      - name: 上传 EXE 构建物
        uses: actions/upload-artifact@v4
        with:
          name: kafka-visark-${{ env.APP_VERSION }}-windows-amd64
          path: ${{ env.ARTIFACT_PATH }}
          retention-days: 30