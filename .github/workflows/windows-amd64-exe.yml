name: windows-amd64-exe

on:
  workflow_dispatch:  # 支持手动触发
  release:
    types: [published]  # 发布版本时自动触发

jobs:
  build:
    runs-on: windows-2022
    env:
      APP_VERSION: ""

    steps:
      - name: 检出项目
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 设置 Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'zulu'
          cache: 'maven'

      - name: 解析版本号 (GitHub Actions 内置)
        id: get-version
        run: |
          # 读取 pom.xml 作为文本
          $pom = Get-Content -Path pom.xml -Raw

          # 使用正则提取版本
          if ($pom -match '<version>([\d\.]+(-SNAPSHOT)?)</version>') {
            $rawVersion = $matches[1]
            $cleanVersion = $rawVersion -replace '-SNAPSHOT$', ''

            "APP_VERSION=$cleanVersion" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            echo "version=$cleanVersion" >> $env:GITHUB_OUTPUT

            Write-Host "✅ 项目版本: $cleanVersion"
          } else {
            Write-Host "❌ 无法在 pom.xml 中找到 <version> 标签"
            exit 1
          }
        shell: pwsh

      - name: 验证 Java
        shell: cmd
        run: |
          java -version
          echo JAVA_HOME: %JAVA_HOME%

      - name: 执行打包 (Windows EXE)
        shell: bash
        run: mvn -e clean jfx:package -DAPP_TYPE=exe -Dfile.encoding=UTF-8 -Dproject.build.sourceEncoding=UTF-8

      - name: 显示项目结构 (Windows 兼容)
        shell: bash
        run: |
            choco install tree
            echo "--- 项目目录结构 ---"
            tree /f /a
      - name: 列举生成的构建物
        run: dir target/javafx
      - name: 上传 EXE 构建物
        uses: actions/upload-artifact@v4
        with:
          name: kafka-visark-${{ env.APP_VERSION }}-windows-amd64
          path: ${{ env.ARTIFACT_PATH }}